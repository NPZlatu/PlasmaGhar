"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),e}var Home=function(){function e(){_classCallCheck(this,e),this.clicked=!1,this.model=[{selector:"fb-firstName",rules:{required:{value:!0,error:"First name is required."}},value:""},{selector:"fb-lastName",rules:{required:{value:!0,error:"Last name is required."}},value:""},{selector:"fb-email",rules:{regex:{value:/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,error:"Please enter a valid email address"}},value:""},{selector:"fb-msg",rules:{required:{value:!0,error:"Message is required."}},value:"Message is required"}],this.filters={blood_group:"",state:"",district:""},this.checkValidation=this.checkValidation.bind(this),this.onFeedBackSubmit=this.onFeedBackSubmit.bind(this),this.requestDistricts=this.requestDistricts.bind(this),this.resetFilters=this.resetFilters.bind(this),this.onSearchClick=this.onSearchClick.bind(this),this.onRequestClick=this.onRequestClick.bind(this),this.setUpListeners()}return _createClass(e,[{key:"setUpListeners",value:function(){this.setUpOnBlurListeners(),this.setUpSearchFieldsListeners(),this.setModalListeners(),this.setSearchListPageListeners(),$(".btn-help").on("click",this.onIWillHelpClick),$(".feedback-send").on("click",this.onFeedBackSubmit),$(".search-btn").on("click",this.onSearchClick)}},{key:"setSearchListPageListeners",value:function(){var e,t;location.href.includes("/search?")&&((e=new URLSearchParams(window.location.search)).has("blood_group")&&(this.filters.blood_group=e.get("blood_group")),e.has("state")&&(this.filters.state=e.get("state")),e.has("district")&&(this.filters.district=e.get("district")),t=this,$(".btn-search-req").on("click",function(){var e=$(this).attr("data-id");t.onRequestClick(e,t.filters,"not-required")}))}},{key:"setModalListeners",value:function(){location.href.includes("/search?")&&$("#searchModal").modal("show"),$("#searchModal").on("hidden.bs.modal",function(){location.href.includes("/search?")?location.href="/":location.reload(!0)})}},{key:"setUpSearchFieldsListeners",value:function(){var s=this;$(".state-dropdown a").on("click",function(){var e=$(this).attr("data-code"),t=$(this).attr("data-name");s.filters.state=t,$(".filter-div").show(),$(".filter-state").show(),$(".select-state").text(t),s.requestDistricts(e)}),$(".bg-dropdown a").on("click",function(){var e=$(this).text();$(".filter-div").show(),$(".filter-bg").show(),$(".select-bg").text(e),s.filters.blood_group=e}),$(".clear-filter").on("click",this.resetFilters)}},{key:"onRequestClick",value:function(e,t,s){"not-required"===s?(e=parseInt(e,10),this.sendRequestToDonor(e,t)):s.id?"donor"===s.role?($.toaster({settings:{timeout:1e4}}),$.toaster({priority:"danger",title:"Error",message:"You are logged in as a donar. You need to be a receiver to be able to request plasma!"})):(e=parseInt(e,10),this.sendRequestToDonor(e,t)):$("#signinModal").modal("show")}},{key:"sendRequestToDonor",value:function(s,e){axios.post("/request/donor",{p_donor_id:s,p_requested_blood_group:e.blood_group,p_requested_state:e.state,p_requested_district:e.district}).then(function(e){var t=e.data;$.toaster({settings:{timeout:6e3}}),t&&t.t_result&&"Your apply request is succeeded."===t.t_result?(e="button[data-id='".concat(s,"']"),$(e).text("Requested"),$(e).prop("disabled",!0),$(e).prop("onclick",null).off("click"),$.toaster({priority:"success",title:"Success",message:"".concat(t.t_result," ").concat(null!==t.t_apply_count?"\nRemaining Quota for today is "+(35-parseInt(t.t_apply_count,10))+".":null)})):($.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong! Please try again later. If the issue persist for long time, please contact us."}))}).catch(function(e){console.log(e),$.toaster({priority:"danger",title:"Error",message:"Something is wrong! Please try again later. If the issue persist for long time, please contact us."})})}},{key:"requestDistricts",value:function(e){var t=this;axios.get("/address/get-districts?code=".concat(e)).then(function(e){e=e.data;e&&0<e.length&&t.populateDistricts(e)}).catch(function(e){})}},{key:"requestSearchLists",value:function(i){var r=this;$(".table-searchlist tbody").html(""),$(".table-searchlist tbody td button").unbind("click"),$("#searchModal").modal("show"),axios.post("/user/search",this.filters).then(function(e){var t,s,e=e.data;0<e.length&&(t=r,s=[],e.forEach(function(e,t){s.push("\n            <tr>\n            <td> ".concat(t+1," </td>\n            <td>Donor-").concat(e.id,"</td>\n            <td> ").concat(e.blood_group,"</td>\n            <td> ").concat(e.district,'</td>\n            <td><button type="button"\n            data-id="').concat(e.id,'"\n            class="btn btn-sm btn-outline-success">Request</button>\n            </td>\n            </tr>\n            '))}),$(".table-searchlist tbody").append(s.join("")),$(".table-searchlist tbody td button").on("click",function(){var e=$(this).attr("data-id");t.onRequestClick(e,t.filters,i)}))}).catch(function(e){console.log(e)})}},{key:"populateDistricts",value:function(e){var t=[];$(".district-dropdown").html(""),e.forEach(function(e){t.push('<a class="dropdown-item" href="javascript:void(0)">'.concat(e.name,"</a>"))}),$(".district-dropdown").append(t.join("")),$(".district-dropdown a").unbind("click");var s=this;$(".district-dropdown a").on("click",function(){var e=$(this).text();$(".filter-div").show(),$(".filter-district").show(),$(".select-district").text(e),s.filters.district=e})}},{key:"setUpOnBlurListeners",value:function(){var o=this;this.model.map(function(e,t){var s=e.selector,i=e.rules,r=o;$("#".concat(s)).blur(function(){r.clicked&&r.showError(s,i,t)})})}},{key:"showError",value:function(e,t,s){var i=$("#".concat(e)),e=i.val(),i=i.next(),r="",o=!0;return!e&&t.required&&t.required.value?t.required.conditions?t.required.conditions.forEach(function(e){e=e.selector;$(e).val()||(o=!1,r=t.required.error)}):(o=!1,r=t.required.error):t.regex?(o=new RegExp(t.regex.value).test(e),t.required&&!1===t.required.value&&(o=!e||o),o||(r=t.regex.error)):t.match&&e!==$("#".concat(t.match.value)).val()&&(o=!1,r=t.match.error),!o&&r?(i.text(r),i.show()):(i.text(""),i.hide()),this.model[s].value=e,o}},{key:"checkValidation",value:function(){for(var e=!0,t=0;t<this.model.length;t++){var s=this.model[t],i=s.selector,s=s.rules;this.showError(i,s,t)||(e=!1)}return e}},{key:"onIWillHelpClick",value:function(){axios.get("/user/who-am-i").then(function(e){e.data.id?window.location.href="/dashboard":$("#signinModal").modal("show")}).catch(function(e){console.log(e)})}},{key:"onSearchClick",value:function(){var t=this,e=this.filters,s=e.blood_group,i=e.state,r=e.district,e=!0;s||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the blood group!"}),e=!1),i||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the state!"}),e=!1),r||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the district!"}),e=!1),e&&axios.get("/user/who-am-i").then(function(e){e=e.data;e.id?"donor"===e.role?($.toaster({settings:{timeout:1e4}}),$.toaster({priority:"danger",title:"Error",message:"You are logged in as a donar. You need to be a receiver to be able to request plasma!"})):t.requestSearchLists(e):($(".confirm-signin").attr("data-nexturl","/search?blood_group=".concat(encodeURIComponent(s),"&state=").concat(encodeURIComponent(i),"&district=").concat(encodeURIComponent(r))),$(".sign-in-text").text("sign in to view donors"),$("#signinModal").modal("show"))})}},{key:"onFeedBackSubmit",value:function(e){e.preventDefault(),this.clicked=!0,this.checkValidation()&&this.sendFeedback()}},{key:"resetForm",value:function(){this.model.forEach(function(e){var t=e.selector;$("#".concat(t)).val(""),e.value=""}),$(".invalid-feedback").hide()}},{key:"resetFilters",value:function(){this.filters={blood_group:"",state:"",district:""},$(".filter-div").hide(),$(".filter-state").hide(),$(".filter-bg").hide(),$(".select-state").html(""),$(".select-bg").html(""),$(".filter-district").hide(),$(".select-district").html(""),$(".district-dropdown").html("")}},{key:"sendFeedback",value:function(){var t=this,e=this.model,e={name:e[0].value+" "+e[1].value,email:e[2].value,message:e[3].value};axios.post("/site/feedback",e).then(function(e){e=e.data;$.toaster({settings:{timeout:3e3}}),e&&e.success?(t.resetForm(),$.toaster({priority:"success",title:"Success",message:"Your feedback has been submitted successfully."})):$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try later"})}).catch(function(e){$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try later"})})}}]),e}();$(document).ready(function(){new Home});