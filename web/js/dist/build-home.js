"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var Home=function(){function e(){_classCallCheck(this,e),this.clicked=!1,this.model=[{selector:"fb-firstName",rules:{required:{value:!0,error:"First name is required."}},value:""},{selector:"fb-lastName",rules:{required:{value:!0,error:"Last name is required."}},value:""},{selector:"fb-email",rules:{regex:{value:/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,error:"Please enter a valid email address"}},value:""},{selector:"fb-msg",rules:{required:{value:!0,error:"Message is required."}},value:"Message is required"}],this.filters={blood_group:"",state:"",district:""},this.checkValidation=this.checkValidation.bind(this),this.onFeedBackSubmit=this.onFeedBackSubmit.bind(this),this.requestDistricts=this.requestDistricts.bind(this),this.resetFilters=this.resetFilters.bind(this),this.onSearchClick=this.onSearchClick.bind(this),this.setUpListeners()}return _createClass(e,[{key:"setUpListeners",value:function(){this.setUpOnBlurListeners(),this.setUpSearchFieldsListeners(),this.setModalListeners(),$(".btn-help").on("click",this.onIWillHelpClick),$(".feedback-send").on("click",this.onFeedBackSubmit),$(".search-btn").on("click",this.onSearchClick)}},{key:"setModalListeners",value:function(){$("#searchModal").on("hidden.bs.modal",function(){location.reload(!0)})}},{key:"setUpSearchFieldsListeners",value:function(){var i=this;$(".state-dropdown a").on("click",function(){var e=$(this).attr("data-code"),t=$(this).attr("data-name");i.filters.state=t,$(".filter-div").show(),$(".filter-state").show(),$(".select-state").text(t),i.requestDistricts(e)}),$(".bg-dropdown a").on("click",function(){var e=$(this).text();$(".filter-div").show(),$(".filter-bg").show(),$(".select-bg").text(e),i.filters.blood_group=e}),$(".clear-filter").on("click",this.resetFilters)}},{key:"onRequestClick",value:function(){axios.get("/user/who-am-i").then(function(e){e=e.data;console.log(e),e.id?"donor"===e.role?($.toaster({settings:{timeout:1e4}}),$.toaster({priority:"danger",title:"Error",message:"You are logged in as a donar. You need to be a receiver to be able to request plasma!"})):alert("we need to do things"):$("#signinModal").modal("show")})}},{key:"requestDistricts",value:function(e){var t=this;axios.get("/address/get-districts?code=".concat(e)).then(function(e){e=e.data;e&&0<e.length&&t.populateDistricts(e)}).catch(function(e){})}},{key:"requestSearchLists",value:function(){var s=this;$(".table-searchlist tbody").html(""),$(".table-searchlist tbody td button").unbind("click"),axios.post("/user/search",this.filters).then(function(e){var t,i,e=e.data;0<e.length&&(t=s,i=[],e.forEach(function(e,t){i.push("\n            <tr>\n            <td> ".concat(t+1," </td>\n            <td>Anonymous-").concat(e.id,"</td>\n            <td> ").concat(e.blood_group,"</td>\n            <td> ").concat(e.district,'</td>\n            <td><button type="button"\n            data-id="').concat(e.id,'"\n            class="btn btn-sm btn-outline-success">Request</button>\n            </td>\n            </tr>\n            '))}),$(".table-searchlist tbody").append(i.join("")),$(".table-searchlist tbody td button").on("click",function(){var e=$(this).attr("data-id");t.onRequestClick(e)}))}).catch(function(e){console.log(e)}),$("#searchModal").modal("show")}},{key:"populateDistricts",value:function(e){var t=[];$(".district-dropdown").html(""),e.forEach(function(e){t.push('<a class="dropdown-item" href="javascript:void(0)">'.concat(e.name,"</a>"))}),$(".district-dropdown").append(t.join("")),$(".district-dropdown a").unbind("click");var i=this;$(".district-dropdown a").on("click",function(){var e=$(this).text();$(".filter-div").show(),$(".filter-district").show(),$(".select-district").text(e),i.filters.district=e})}},{key:"setUpOnBlurListeners",value:function(){var o=this;this.model.map(function(e,t){var i=e.selector,s=e.rules,r=o;$("#".concat(i)).blur(function(){r.clicked&&r.showError(i,s,t)})})}},{key:"showError",value:function(e,t,i){var s=$("#".concat(e)),e=s.val(),s=s.next(),r="",o=!0;return!e&&t.required&&t.required.value?t.required.conditions?t.required.conditions.forEach(function(e){e=e.selector;$(e).val()||(o=!1,r=t.required.error)}):(o=!1,r=t.required.error):t.regex?(o=new RegExp(t.regex.value).test(e),t.required&&!1===t.required.value&&(o=!e||o),o||(r=t.regex.error)):t.match&&e!==$("#".concat(t.match.value)).val()&&(o=!1,r=t.match.error),!o&&r?(s.text(r),s.show()):(s.text(""),s.hide()),this.model[i].value=e,o}},{key:"checkValidation",value:function(){for(var e=!0,t=0;t<this.model.length;t++){var i=this.model[t],s=i.selector,i=i.rules;this.showError(s,i,t)||(e=!1)}return e}},{key:"onIWillHelpClick",value:function(){axios.get("/user/who-am-i").then(function(e){e.data.id?window.location.href="/dashboard":$("#signinModal").modal("show")}).catch(function(e){console.log(e)})}},{key:"onSearchClick",value:function(){var e=this.filters,t=e.blood_group,i=e.state,s=e.district,e=!0;t||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the blood group!"}),e=!1),i||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the state!"}),e=!1),s||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the district!"}),e=!1),e&&this.requestSearchLists()}},{key:"onFeedBackSubmit",value:function(e){e.preventDefault(),this.clicked=!0,this.checkValidation()&&this.sendFeedback()}},{key:"resetForm",value:function(){this.model.forEach(function(e){var t=e.selector;$("#".concat(t)).val(""),e.value=""}),$(".invalid-feedback").hide()}},{key:"resetFilters",value:function(){this.filters={blood_group:"",state:"",district:""},$(".filter-div").hide(),$(".filter-state").hide(),$(".filter-bg").hide(),$(".select-state").html(""),$(".select-bg").html(""),$(".filter-district").hide(),$(".select-district").html(""),$(".district-dropdown").html("")}},{key:"sendFeedback",value:function(){var t=this,e=this.model,e={name:e[0].value+" "+e[1].value,email:e[2].value,message:e[3].value};axios.post("/site/feedback",e).then(function(e){e=e.data;$.toaster({settings:{timeout:3e3}}),e&&e.success?(t.resetForm(),$.toaster({priority:"success",title:"Success",message:"Your feedback has been submitted successfully."})):$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try later"})}).catch(function(e){$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try later"})})}}]),e}();$(document).ready(function(){new Home});