"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var s=0;s<e.length;s++){var o=e[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,s){return e&&_defineProperties(t.prototype,e),s&&_defineProperties(t,s),t}var Dashboard=function(){function t(){_classCallCheck(this,t),this.filters={blood_group:"",state:"",district:""},this.setUpListeners(),this.requestDistricts=this.requestDistricts.bind(this),this.onSearchClick=this.onSearchClick.bind(this)}return _createClass(t,[{key:"setUpListeners",value:function(){this.setUpSearchFieldsListeners(),this.setUpRequestListsForDonorListeners()}},{key:"setUpRequestListsForDonorListeners",value:function(){$(".donor-accept-btn").on("click",this.onAcceptBtnClick),$(".donor-bloodconfirm-btn").on("click",this.onBloodConfirmBtnClickByDonor),$(".donor-reject-btn").on("click",this.onDonorRejectBtnClick),$(".receiver-reject-btn").on("click",this.onReceiverRejectBtnClick),$(".receiver-bloodconfirm-btn").on("click",this.onBloodConfirmBtnClickByReceiver)}},{key:"onAcceptBtnClick",value:function(){var t=$(this).data("params"),t={p_donor_id:t.donor_id,p_requested_blood_group:t.requested_blood_group,p_requested_state:t.requested_state,p_requested_district:t.requested_district,p_receiver_id:t.receiver_id,p_action:"accept",p_action_by:"donor",p_relationship:"diff"};axios.post("/accept/requester",t).then(function(t){t=t.data;$.toaster({settings:{timeout:2e4}}),$.toaster({priority:"success",title:"Success",message:t.t_result+" Your number is now sent to the accepted requester. Please expect a call from him/her. If he/she doesn't call,reject the request. If he/she calls and blood is confirmed, please change the status to Blood Confirmed."})}).catch(function(t){console.log(t)})}},{key:"onBloodConfirmBtnClickByDonor",value:function(){var t=$(this).data("params"),t={p_donor_id:t.donor_id,p_requested_blood_group:t.requested_blood_group,p_requested_state:t.requested_state,p_requested_district:t.requested_district,p_receiver_id:t.receiver_id,p_action:"accept",p_action_by:"donor",p_relationship:"same"};axios.post("/confirm/blood",t).then(function(t){"Your accept request is succeeded."===t.data.t_result?($.toaster({settings:{timeout:2e4}}),$.toaster({priority:"success",title:"Success",message:"Thank you for donating the plasma. Your small help does save a needy life."})):($.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."}))}).catch(function(t){console.log(t),$.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."})})}},{key:"onBloodConfirmBtnClickByReceiver",value:function(){var t=$(this).data("params"),t={p_donor_id:t.donor_id,p_requested_blood_group:t.requested_blood_group,p_requested_state:t.requested_state,p_requested_district:t.requested_district,p_receiver_id:t.receiver_id,p_action:"accept",p_action_by:"receiver",p_relationship:"same"};axios.post("/confirm/blood",t).then(function(t){"Your accept request is succeeded."===t.data.t_result?($.toaster({settings:{timeout:2e4}}),$.toaster({priority:"success",title:"Success",message:"Thank you for the confirmation."})):($.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."}))}).catch(function(t){console.log(t),$.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."})})}},{key:"onDonorRejectBtnClick",value:function(){var t=$(this).data("params"),e="same";"pendingApprovals"===$(this).data("section")&&(e="diff");e={p_donor_id:t.donor_id,p_requested_blood_group:t.requested_blood_group,p_requested_state:t.requested_state,p_requested_district:t.requested_district,p_receiver_id:t.receiver_id,p_action:"cancel",p_action_by:"donor",p_relationship:e};axios.post("/cancel/request",e).then(function(t){t=t.data;"Your cancel request is succeeded."===t.t_result?($.toaster({settings:{timeout:2e4}}),$.toaster({priority:"success",title:"Success",message:t.t_result})):($.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."}))}).catch(function(t){console.log(t),$.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."})})}},{key:"onReceiverRejectBtnClick",value:function(){var t=$(this).data("params"),e="same";"pendingApprovals"===$(this).data("section")&&(e="diff");e={p_donor_id:t.donor_id,p_requested_blood_group:t.requested_blood_group,p_requested_state:t.requested_state,p_requested_district:t.requested_district,p_receiver_id:t.receiver_id,p_action:"cancel",p_action_by:"receiver",p_relationship:e};axios.post("/cancel/request",e).then(function(t){t=t.data;"Your cancel request is succeeded."===t.t_result?($.toaster({settings:{timeout:2e4}}),$.toaster({priority:"success",title:"Success",message:t.t_result})):($.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."}))}).catch(function(t){$.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong. Please try again later."})})}},{key:"setUpSearchFieldsListeners",value:function(){var s=this;$(".state-options a").on("click",function(){var t=$(this).attr("data-code"),e=$(this).attr("data-name");s.filters.state=e,$("#dash-state-select").text(e),s.requestDistricts(t)}),$(".bg-options a").on("click",function(){var t=$(this).text();$(".bg-dropdown-link").text(t),s.filters.blood_group=t}),$(".search-btn-dash").on("click",function(){s.onSearchClick()}),$("#searchModal").on("hidden.bs.modal",function(){location.reload(!0)})}},{key:"requestDistricts",value:function(t){var e=this;axios.get("/address/get-districts?code=".concat(t)).then(function(t){t=t.data;t&&0<t.length&&e.populateDistricts(t)}).catch(function(t){})}},{key:"populateDistricts",value:function(t){var e=[];$(".district-dropdown").html(""),t.forEach(function(t){e.push('<a class="dropdown-item" href="javascript:void(0)">'.concat(t.name,"</a>"))}),$(".district-dropdown").append(e.join("")),$(".district-dropdown a").unbind("click");var s=this;$(".district-dropdown a").on("click",function(){var t=$(this).text();$("#dash-district-select").text(t),s.filters.district=t})}},{key:"onSearchClick",value:function(){var t=this.filters,e=t.blood_group,s=t.state,o=t.district,t=!0;e||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the blood group!"}),t=!1),s||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the state!"}),t=!1),o||($.toaster({settings:{timeout:4e3}}),$.toaster({priority:"danger",title:"Error",message:"Please choose the district!"}),t=!1),t&&this.requestSearchLists()}},{key:"requestSearchLists",value:function(){var o=this;$(".table-searchlist tbody").html(""),$(".table-searchlist tbody td button").unbind("click"),axios.post("/user/search",this.filters).then(function(t){var e,s,t=t.data;0<t.length&&(e=o,s=[],t.forEach(function(t,e){s.push("\n            <tr>\n            <td> ".concat(e+1," </td>\n            <td>Donor-").concat(t.id,"</td>\n            <td> ").concat(t.blood_group,"</td>\n            <td> ").concat(t.district,'</td>\n            <td><button type="button"\n            data-id="').concat(t.id,'"\n            class="btn btn-sm btn-outline-success">Request</button>\n            </td>\n            </tr>\n            '))}),$(".table-searchlist tbody").append(s.join("")),$(".table-searchlist tbody td button").on("click",function(){var t=$(this).attr("data-id");e.sendRequestToDonor(t,e.filters)}))}).catch(function(t){console.log(t)}),$("#searchModal").modal("show")}},{key:"sendRequestToDonor",value:function(s,t){axios.post("/request/donor",{p_donor_id:s,p_requested_blood_group:t.blood_group,p_requested_state:t.state,p_requested_district:t.district}).then(function(t){var e=t.data;$.toaster({settings:{timeout:6e3}}),e&&e.t_result&&"Your apply request is succeeded."===e.t_result?(t="button[data-id='".concat(s,"']"),$(t).text("Requested"),$(t).prop("disabled",!0),$(t).prop("onclick",null).off("click"),$.toaster({priority:"success",title:"Success",message:"".concat(e.t_result," ").concat(null!==e.t_apply_count?"\nRemaining Quota for today is "+(35-parseInt(e.t_apply_count,10))+".":null)})):($.toaster({settings:{timeout:1e3}}),$.toaster({priority:"danger",title:"Error",message:"Something is wrong! Please try again later. If the issue persist for long time, please contact us."}))}).catch(function(t){console.log(t),$.toaster({priority:"danger",title:"Error",message:"Something is wrong! Please try again later. If the issue persist for long time, please contact us."})})}}]),t}();$(document).ready(function(){new Dashboard});